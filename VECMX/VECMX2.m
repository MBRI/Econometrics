
function [xfinal,nM]=VECMX2
clear

%Inputs
% X: I(0) exogenous variable. 
% Y: I(1) Variable
% Note: Each Column as a Variable
% and Each Row as a Period of time
% r: number of cointegration vector
% RYL: Restrictions on long run variables
% RYC: Restrictions on correction terms
% RDS: Restrictions on Shortrun transition
% RX: Restriction on Exogenous 
% Model
% D(Y)= a*b*Y(-1)+g*D(Y(-1)+h*X+e~i.i.d(0,Sig)
%% User input
Y=[NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN;13.5761418400000,0.810930216000000,7.21926861800000,0.689967528000000,9.15377002000000,5.33382405500000,59.6759271400000,4.06216566400000;13.5912554800000,0.832909123000000,7.24342004700000,0.710738143000000,9.17905608200000,5.32109355100000,59.6838588700000,4.07073469700000;13.6063691200000,0.854415328000000,7.25991805800000,0.731535633000000,9.20432230000000,5.48849089900000,59.6838340500000,4.08092154200000;13.6214827500000,0.871293366000000,7.29623020100000,0.752230067000000,9.22965268300000,5.67034212400000,59.6662371700000,4.09100566100000;13.6513396800000,0.891998039000000,7.25134498300000,0.772888241000000,9.25502689000000,5.69658222200000,59.6565251900000,4.10098910500000;13.6656441900000,0.924258902000000,7.25559127400000,0.813446312000000,9.26302769400000,5.73012100300000,59.6682639600000,4.11414719000000;13.6963947600000,0.970778917000000,7.25276241800000,0.846150934000000,9.27967985000000,5.66136355700000,59.6766744100000,4.12390336400000;13.7389480400000,1.02245092800000,7.25559127400000,0.877889522000000,9.30273722100000,5.54148383400000,59.6845039600000,4.13196142600000;13.7652987800000,1.08180517000000,7.25770767700000,0.899017672000000,9.33714921900000,5.54323177300000,59.7063386400000,4.13836144800000;13.8151845000000,1.14422280000000,7.27031288600000,0.920507421000000,9.37058672100000,5.55567887500000,59.7274762600000,4.14630430100000;13.8344873500000,1.20297230400000,7.27862894200000,0.944314977000000,9.40302471600000,5.55935240600000,59.7480083300000,4.15418456300000;13.8246744400000,1.25276296800000,7.28892769500000,0.961048686000000,9.43978403600000,5.55876270500000,59.7689264000000,4.16200321100000;13.8033337200000,1.30019166200000,7.31853954900000,0.977686645000000,9.47784524700000,5.56412356700000,59.7726091800000,4.16976120200000;13.7977110800000,1.34547236700000,7.35051617200000,0.987767845000000,9.52369019100000,5.55583270700000,59.7853632300000,4.17745946900000;13.8054238600000,1.39128190300000,7.37462901500000,1.00911773900000,9.56514356500000,5.50705012100000,59.7958555200000,4.18509892500000;13.8114834600000,1.44456326900000,7.41216033500000,1.03907865700000,9.59920173100000,5.44051008200000,59.8221026700000,4.19116874700000;13.8176213300000,1.50629715400000,7.50108212400000,1.06563033100000,9.64484634900000,5.37360616600000,59.8414841700000,4.19720194800000;13.7939201500000,1.57069708400000,7.62413058600000,1.08110564800000,9.69818391900000,5.32704862500000,59.8686595200000,4.20319896700000;13.7992063600000,1.64093657900000,7.72312009200000,1.09307016900000,9.75202492300000,5.32250322800000,59.8814918600000,4.21064501800000;13.8054814300000,1.71918877600000,7.82084088000000,1.09387255600000,9.82005159400000,5.33452697000000,59.9035799200000,4.21656219500000;13.8223431600000,1.80664808200000,7.88382321500000,1.09082935600000,9.89014898800000,5.36486704100000,59.9084874600000,4.22390976700000;13.8178528100000,1.92278773200000,8.05038445300000,1.09518616100000,9.95470334400000,5.39389178200000,59.9127855400000,4.23120374500000;13.8143098400000,2.02551320000000,8.14786713000000,1.08843666200000,10.0352611500000,5.37335255200000,59.9295130000000,4.23844490600000;13.8280130700000,2.12106321600000,8.23057721700000,1.05580717900000,10.1397052600000,5.36893493400000,59.9434009600000,4.24420031800000;13.8530336800000,2.20827441400000,8.30622521600000,1.03103051800000,10.2371701900000,5.37176374400000,59.9570632700000,4.25134831100000;13.8755015700000,2.27212588600000,8.28626945300000,1.01137509900000,10.3287552900000,5.38756574900000,59.9913376200000,4.25844557300000;13.8915313400000,2.32727770600000,8.31801027800000,1.00126990500000,10.4083152200000,5.46006352600000,60.0086684200000,4.26549281800000;13.9000842200000,2.37583555500000,8.36334246700000,0.996264479000000,10.4827939200000,5.54598343100000,60.0303837000000,4.27249074800000;13.9123250600000,2.41680623700000,8.39953514800000,0.993611105000000,10.5621726800000,5.58496155600000,60.0457041900000,4.28082412900000;13.9179434900000,2.45616418100000,8.43032725800000,0.982707522000000,10.6474941800000,5.57005456000000,60.0751406700000,4.28634138500000;13.9215061700000,2.49815187700000,8.45595588200000,0.981529621000000,10.7175019000000,5.53044913000000,60.1000834500000,4.29182836700000;13.9319442400000,2.53528285700000,8.46041117700000,0.995671636000000,10.7622762800000,5.46406237900000,60.1153612000000,4.29728540600000;13.9403645400000,2.57642175900000,8.47345026800000,1.01267889400000,10.7938038500000,5.34529921200000,60.1341718900000,4.30135873200000;13.9478309700000,2.61739583300000,8.51438926400000,1.03771131700000,10.8089397600000,5.23710215200000,60.1520809300000,4.30541553200000;13.9596767000000,2.65675690700000,8.56750600500000,1.06004194500000,10.8284803100000,5.11599581000000,60.1782985400000,4.30945594200000;13.9653777900000,2.70001802900000,8.65834547100000,1.07603463300000,10.8599600700000,4.95324061300000,60.2126148400000,4.31348009200000;13.9681020200000,2.74277363700000,8.77462222100000,1.08266247400000,10.9016531600000,4.88683418600000,60.2303479000000,4.31748811400000;13.9828800500000,2.79300390700000,8.87542692000000,1.08425410500000,10.9521565100000,4.93478916900000,60.2459214000000,4.32148013500000;13.9768553000000,2.83907846400000,8.98243550400000,1.08761790500000,10.9994797500000,5.03542456100000,60.2712037800000,4.32677816000000;13.9857392900000,2.88256357500000,9.04227668700000,1.09905162800000,11.0381263600000,5.18813333800000,60.3067941000000,4.33336146300000;13.9848355200000,2.92584614600000,9.06126014900000,1.10896113600000,11.0719834300000,5.45135135200000,60.3120213400000,4.34120464000000;13.9880292200000,2.95647156000000,9.06462071800000,1.12526835200000,11.1009794000000,5.55249876900000,60.3506539300000,4.34898678100000;14.0058738600000,2.98770010200000,9.04073758800000,1.14540299400000,11.1272482800000,5.68699705800000,60.3523422800000,4.35799005700000;14.0157285100000,3.01798288200000,9.02316706400000,1.16181608100000,11.1596589900000,5.76338507300000,60.3641563600000,4.36564315500000;14.0329820500000,3.04452243800000,9.01066917700000,1.18765354800000,11.1969125000000,5.72455596800000,60.3575760100000,4.37449836800000;14.0391220000000,3.07176696000000,8.99838401000000,1.20703561800000,11.2447714700000,5.72925632500000,60.3706271200000,4.38327585400000;14.0517732800000,3.09919098200000,8.99118884200000,1.24501582000000,11.2768233100000,5.66068328200000,60.3651097700000,4.38949865000000;14.0602527700000,3.12500460900000,8.98857087600000,1.28611459600000,11.3041654700000,5.56889969100000,60.3720876300000,4.39568296100000;14.0646796900000,3.15230858100000,8.98832118800000,1.31770795300000,11.3367966900000,5.47055549600000,60.3890951500000,4.39937527300000;14.0906771400000,3.18593932500000,8.98769669600000,1.34648006600000,11.3727664400000,5.42099038700000,60.3997060800000,4.40182926200000;14.1104708300000,3.22167191200000,8.98782162500000,1.33962525800000,11.4467001900000,5.40312828100000,60.4098295300000,4.40549899100000;14.1212496200000,3.25848107900000,8.98782162500000,1.33966960500000,11.5109034200000,5.45697099800000,60.4105198600000,4.41037110800000;14.1442263600000,3.29879544800000,8.98956900500000,1.35016298600000,11.5648440600000,5.61731925300000,60.4188368900000,4.41763506200000;14.1665054000000,3.33541364100000,8.99553694500000,1.37035211500000,11.6026199100000,5.67622805700000,60.4357087000000,4.42364830900000;14.1854410600000,3.37279790700000,9.00552777700000,1.40675192400000,11.6245920600000,5.75910503100000,60.4683608400000,4.42843300700000;14.2045935400000,3.40883480900000,9.01663425600000,1.43919461700000,11.6525569600000,5.77887966400000,60.4863673200000,4.43319492100000;14.2195493200000,3.44137917100000,9.02677804600000,1.47126641100000,11.6810382200000,5.76676837300000,60.4994984100000,4.43793426700000;14.2383917900000,3.47815842300000,9.03860260900000,1.50049168600000,11.7109973300000,5.81873258500000,60.5123306700000,4.44382703600000;14.2594024700000,3.51452606700000,9.05064099300000,1.53009426100000,11.7473016900000,5.88733496000000,60.5271657700000,4.45085282600000;14.2670090200000,3.55047908400000,9.06276800800000,1.55950777700000,11.7805298200000,5.98070080700000,60.5434583800000,4.45898767600000;14.2817339300000,3.58573869500000,9.07635173200000,1.58720712300000,11.8157744400000,6.04815989100000,60.5639868600000,4.46590811900000;14.2951971600000,3.61952937600000,9.08636319200000,1.61206289700000,11.8532474200000,6.13562905900000,60.5728684300000,4.47392189900000;14.3043126300000,3.64231181800000,9.09448048600000,1.62806458700000,11.9039670500000,6.20370137800000,60.5886839300000,4.48300255200000;14.3206442100000,3.66433058100000,9.10230962800000,1.65102745500000,11.9531977100000,6.26334493600000,60.5989334600000,4.49200148800000;14.3502743600000,3.68436929900000,9.10963566800000,1.65306637900000,12.0228406700000,6.29497517900000,60.6240274200000,4.50092016500000;14.3701982200000,3.70204244100000,9.11602969300000,1.65149209900000,12.1003009300000,6.34312694900000,60.6321218100000,4.51085950700000;14.3865398200000,3.72785975400000,9.12107190400000,1.64250701300000,12.1857934000000,6.45323036300000,60.6323843700000,4.51961229800000;14.4073755600000,3.75957088200000,9.12554472000000,1.64217731600000,12.2632891100000,6.46986322900000,60.6459287100000,4.52504414200000;14.4138617800000,3.79661215400000,9.12978086400000,1.65364256700000,12.3362716200000,6.51183499100000,60.6486419300000,4.53044664000000;14.4279551500000,3.83492595500000,9.13356731300000,1.64980837300000,12.4244367900000,6.55550613400000,60.6665606700000,4.53689134500000;14.4476479200000,3.87494399700000,9.13733947900000,1.65016877900000,12.5047354600000,6.53977041800000,60.6811125700000,4.54329478200000;14.4577633100000,3.91840261200000,9.14141892700000,1.63321619800000,12.5968335100000,6.64260232000000,60.6895650400000,4.55176940900000;14.4612102000000,3.96594284700000,9.14388000500000,1.61673266100000,12.6772474600000,6.75032510700000,60.6806603600000,4.56121829800000;14.4586099800000,4.02320653400000,9.14259672000000,1.61417978700000,12.7300790200000,6.83082732900000,60.6872374100000,4.57161340200000;14.4531344600000,4.08446256200000,9.14633504200000,1.59279914000000,12.7891007800000,6.95708034600000,60.6685788400000,4.58394655000000;14.4583634200000,4.14582950500000,9.16398224800000,1.55827428500000,12.8540393900000,6.87339898300000,60.6220258600000,4.59107126200000;14.4707393400000,4.19162250200000,9.17668017000000,1.51890324400000,12.9267401400000,6.72068080400000,60.5950665400000,4.59208494600000;14.4784964200000,4.22595744900000,9.19339765100000,1.47944682400000,13.0105442700000,6.58557634400000,60.5934924800000,4.59005654800000;14.4900899200000,4.25419326300000,9.20603110000000,1.47317540600000,13.0732991800000,6.37322942200000,60.6006758400000,4.58700621500000;14.4930272200000,4.27221176900000,9.20351714700000,1.49761847500000,13.1060957700000,6.43665236800000,60.6204107400000,4.58802402700000;14.4995574600000,4.29401475700000,9.20813794800000,1.51836291200000,13.1421189400000,6.56072139100000,60.6319519000000,4.59309760500000;14.5098490300000,4.31628739300000,9.21811010900000,1.53979205100000,13.1792672000000,6.63249572700000,60.6430428400000,4.59713801400000;14.5244912200000,4.33938006000000,9.23171039800000,1.55687003100000,13.2164746600000,6.67768518400000,60.6558897600000,4.60116216500000;14.5401079500000,4.36881474100000,9.24869532600000,1.54797372900000,13.2794696900000,6.67303344600000,60.6677141600000,4.60416968600000;14.5554874100000,4.41061409200000,9.27011757600000,1.55559251000000,13.3297010700000,6.76116228900000,60.6681086200000,4.60916220700000;14.5680675100000,4.46049117500000,9.29935806800000,1.56868383700000,13.3699247700000,6.89320884300000,60.6803437600000,4.61611012600000;14.5789344500000,4.50953995500000,9.33034316400000,1.59025137500000,13.3966242900000,6.96565415900000,60.6866964100000,4.62497281300000;14.5852154600000,4.55849777800000,9.39391114800000,1.62966004400000,13.4049766300000,7.05261680000000,60.7067504900000,4.63375764300000;14.5845696200000,4.60527018100000,9.54294800800000,1.65252329300000,13.4258592500000,7.03984982900000,60.7164583100000,4.64053733000000;14.5624231200000,4.65548300000000,9.64801448900000,1.66608397900000,13.4648418300000,6.91311516900000,60.7226827000000,4.64631212900000;14.5374308000000,4.71231910200000,9.78402811200000,1.67040522700000,13.5204130600000,6.74641549600000,60.7379763300000,4.65109911800000;14.5195774000000,4.78707498900000,10.0036495800000,1.66968414200000,13.5882071200000,6.60634155200000,60.7398652000000,4.65491227800000;14.5144181200000,4.87167969300000,10.1735146900000,1.67647784400000,13.6502348900000,6.46966132000000,60.7486709900000,4.65965837100000;14.5046833500000,4.96221506100000,10.3282976700000,1.69786670000000,13.6870713200000,6.40460453000000,60.7574300400000,4.66343909400000;14.5022175400000,5.04966368100000,10.4150828800000,1.71371955200000,13.7264366900000,6.39598936400000,60.7795161900000,4.66720557700000;14.4978278100000,5.11829316900000,10.4064725200000,1.74092546400000,13.7543912500000,6.37433964200000,60.7967171500000,4.67002115800000;14.4949912800000,5.16980194400000,10.3656795000000,1.76044098600000,13.7904706600000,6.40514357200000,60.7860707500000,4.67376297700000;14.5041892700000,5.20691454300000,10.3396758300000,1.76803107200000,13.8413264400000,6.42623578200000,60.8085192500000,4.67842064800000;14.5143152000000,5.24105894800000,10.3349777200000,1.79323271300000,13.8741275200000,6.44450033400000,60.8327559500000,4.68305672500000;14.5210718600000,5.27729799900000,10.3595190200000,1.80872212000000,13.9117820900000,6.38222919700000,60.8437220300000,4.68675017300000;14.5243160100000,5.31443674800000,10.3962001200000,1.77269443700000,13.9978321100000,6.23376053100000,60.8428626800000,4.68767140700000;NaN,5.35209507200000,10.4055650200000,NaN,NaN,NaN,NaN,4.68675017300000]; % I(1) var
X=[NaN,NaN;NaN,NaN;NaN,NaN;NaN,NaN;NaN,NaN;NaN,0;NaN,0;NaN,0;0.0619014680000000,0.500000000000000;0.0617528970000000,0;0.0619560150000000,0;0.0619078770000000,0;0.0976660750000000,0;0.0692184180000000,0;0.0779651290000000,0;0.0575197210000000,0;0.0384781040000000,1;0.0697483350000000,0;0.0718157120000000,0;0.0869677600000000,0;0.179181937000000,1.50000000000000;0.214862931000000,0;0.116876711000000,0;0.133257895000000,0;0.0835327610000000,0;0.0761023400000000,0;0.117319985000000,0;0.0803746860000000,0;0.0602886680000000,2.50000000000000;0.0701581340000000,0;0.0691722940000000,0;0.127214206000000,0;0.0737320290000000,0;0.0593194210000000,0;0.0788385350000000,0;0.113869898000000,0;0.0709816550000000,0;0.0581143860000000,0;0.0533631590000000,0;0.00585519300000000,0;0.00802548200000000,0;-0.00924249000000000,0;-0.00502057300000000,0;0.0534518720000000,0;0.0504358460000000,0;0.0654714230000000,0;0.0892582230000000,0;0.0713713870000000,0;0.0623356970000000,0;0.0504377990000000,0;0.0184579290000000,0;0.00940858100000000,0;0.00279587000000000,-1;0.0835519710000000,0;0.0634867060000000,0;0.0582609930000000,0;0.0635073170000000,0;0.151100764000000,0;0.0707120550000000,0;0.0790621090000000,0;0.195144849000000,0;0.164200775000000,0;0.136952036000000,0;0.118976846000000,0;0.0385089940000000,0;0.0844660810000000,0;0.0509450320000000,0;0.0833725010000000,0;-0.0289995290000000,0;-0.0502338890000000,0;-0.0633965730000000,0;0.152909591000000,0;0.101517199000000,1;0.0509895890000000,0;0.0979838540000000,0;-0.0260926410000000,0;-0.00656101000000000,0.500000000000000;0.0670050650000000,0;-0.00529629300000000,0;-0.0415329620000000,0;0.0199283880000000,0;0.0757619390000000,0;0.116623864000000,0;0.100168927000000,0;-0.00376131100000000,0;0.0126648900000000,0;-0.0418530130000000,0;0.0510051090000000,0;0.0345093970000000,-0.500000000000000;-0.00440730500000000,0;0.0568212090000000,0;0.0378339150000000,0;0.0194291250000000,-1.50000000000000;0.0790286770000000,0;0.0332055980000000,0;0.131009389000000,4.50000000000000;-0.00691593100000000,0;-0.0206297160000000,0;0.00220460900000000,0;-0.0874387980000000,0;0.0826838120000000,0;0.0179795760000000,0;0.0671179850000000,0;0.139925836000000,0;0.0536736520000000,5;0.107985375000000,0;0.0638594640000000,0;-0.0219985340000000,0;NaN,NaN]; % I(0) var
r=3; 
nX=size(X,2);
nY=size(Y,2);

RYL=nan(r,nY);
RYC=nan(nY,r);
RDS=nan(nY,nY);
RX=nan(nY,nX);
% extra restriction
RYL(1,1)=-1; RYL(1,2)=0;RYL(1,3)=0; RYL(1,4)=0; RYL(1,5)=0; RYL(1,8)=0; 
RYL(2,2)=-1; RYL(2,3)=0;RYL(2,4)=1; RYL(2,5)=1; RYL(2,6)=0; RYL(2,7)=0; RYL(2,8)=0;
RYL(3,1)=0; RYL(3,2)=1; RYL(3,3)=-1; RYL(3,4)=0;  RYL(3,5)=0; RYL(3,7)=0; RYL(3,8)=-1;
RYC(7,1)=0; RYC(7,2)=0; RYC(7,3)=0;    
RYC(6,1)=0; RYC(6,2)=0; RYC(6,3)=0;    
RYC(8,1)=0; RYC(8,2)=0; RYC(8,3)=0;


%  restriction for Cov Mtrix
RSig=diag(nan(nY,1));
%% Prim Parameters
% number of I(1) variables.
NI1=size(Y,2);
% number of I(0) variables
NI0=size(X,2);
%number of periods
NP=size(Y,1);
% Check Some of Errors
if size(Y,1)~=size(X,1)
   error('The nubmber of rows of Y & X is not equal'); 
end
if sumsqr([r, NI1]-size(RYL))>0
    error('The size of RYL is not Consistent'); 
end
if sumsqr([NI1, r]-size(RYC))>0
    error('The size of RYC is not Consistent'); 
end
if sumsqr([NI1, NI1]-size(RDS))>0
    error('The size of RDS is not Consistent'); 
end
if sumsqr([NI1, NI0]-size(RX))>0
    error('The size of RX is not Consistent'); 
end
% Create Symbolic variables
a = sym('a',[NI1,r]);
b = sym('b',[r,NI1]);
g= sym('g',[NI1,NI1]);
h = sym('h',[NI1,NI0]);
Sig=sym('Sig',[NI1,NI1]);
% impose restriction
a(isfinite(RYC))=RYC(isfinite(RYC)); % short run Restriction on Correction term
b(isfinite(RYL))=RYL(isfinite(RYL)); % Long run Restriction
g(isfinite(RDS))=RDS(isfinite(RDS)); % short run Restriction on deffrences
h(isfinite(RX))=RX(isfinite(RX)); % Restriction Exogensios var
Sig(isfinite(RSig))=RSig(isfinite(RSig)); % Va-cov Matrix Restrictions

% build error symbolic function
Y2=lagmatrix(Y,1);
Y1=Y-Y2;
Y3=lagmatrix(Y1,1);
[Y1,Y2,Y3,X]=remnan(Y1,Y2,Y3,X);
e=Y1.'-a*b*Y2.'-g*Y3.'-h*X.';
%e=e.';
% ML

%% Stage1: Estimate Unknown Parameters
% the e must fit to an multivariate normal distribution with mean 0 and var
% Sig by decision variables a,b,g,h,Sig
% every ??Columns?? of e ccorrespond to a normal distribution  
K=NI1;
T=NP;
%Sig=eye(K);
Teta=[symvar(e),symvar(Sig)];%[issym(a);issym(b);issym(g);issym(h)];

ML= -((K*T)/2)*log(2*pi)-(T/2)*log(det(Sig))-(1/2)*trace(e.'*Sig^-1*e); % -((K*T)/2)*log(2*pi)


options = optimoptions('fminunc','Display','notify-detailed','Algorithm','quasi-newton','MaxFunctionEvaluations',10^20,'OptimalityTolerance',10^-3); %'trust-region'
ML2 = matlabFunction(ML,'vars',{Teta});
% fh2 = objective with no gradient or Hessian
[xfinal,fval,exitflag,output2] = fminunc(ML2,SPoint(Teta,Y,Y1,Y2,Y3,X),options);
nM=char(Teta);
%xfinal;

end
%% Stage2: Calculate asymptotic distributions
% it is not the case now
%% other
function [Res]=SPoint(Teta,Y,Y1,Y2,Y3,X,a,b,g,h)
% find startinf point for estimation
n_P=size(Teta,2);
Res=ones(1,n_P);
%[~,~,~,~,mles] = jcitest(Y,'model','H1','lags',1,'display','params');

%Par=mles.r3(1,1).paramVals;
%a=Par.A;
Tt=symvar(b);
BH=double(subs(b,Tt,ones(size(Tt)))); % Initail b

XX=[BH*Y2.';Y3.';X.']; %e=Y1.'-a*BH*Y2.'-g*Y3.'-h*X.';
AH=(XX.'*XX)^-1*XX.'*Y1;
%[h2,pValue2,stat2,cValue2,mles2] = jcontest(Y,1,'BCon',[1 -1 -1]','lags',2)
end